---
name: docker

on:
  push:
    branches: [master]

jobs:
  freebsd:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build freebsd image
        run: make -C freebsd build
      - name: Push images to DockerHub
        run: docker push toxchat/freebsd:latest

  ##################################################
  #
  # :: GHC for Android
  #
  ##################################################

  ghc-base:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push image
        run: .github/scripts/build-image ghc/base toktoknet/ghc:8.10.7

  ghc-android-aarch64:
    runs-on: ubuntu-latest
    needs: ghc-base
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push image
        run: .github/scripts/build-image ghc-android/aarch64 toktoknet/ghc-android:8.10.7.aarch64

  ghc-android-arm:
    runs-on: ubuntu-latest
    needs: ghc-base
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push image
        run: .github/scripts/build-image ghc-android/arm toktoknet/ghc-android:8.10.7.arm

  ghc-android-i686:
    runs-on: ubuntu-latest
    needs: ghc-base
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push image
        run: .github/scripts/build-image ghc-android/i686 toktoknet/ghc-android:8.10.7.i686

  ghc-android-x86_64:
    runs-on: ubuntu-latest
    needs: ghc-base
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push image
        run: .github/scripts/build-image ghc-android/x86_64 toktoknet/ghc-android:8.10.7.x86_64
